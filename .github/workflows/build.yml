name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-2022, macos-latest]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install setuptools (for sqlite3 on macOS)
        if: runner.os == 'macOS'
        run: pip install setuptools
      
      - name: Install build tools (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install visualstudio2022-workload-vctools visualstudio2022-workload-nativedesktop -y
          refreshenv
      
      - name: Clear npm cache
        run: npm cache clean --force
      
      - name: Install dependencies
        run: npm install
      
      - name: Generate icon assets
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            const assetsDir = 'assets';
            
            // Ensure assets directory exists
            if (!fs.existsSync(assetsDir)) {
              fs.mkdirSync(assetsDir, { recursive: true });
            }
            
            // Create a simple placeholder PNG icon (256x256)
            // This is a base64 encoded 256x256 transparent PNG
            const pngBase64 = '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'
            
            // Create PNG file
            const buffer = Buffer.from(pngBase64, 'base64');
            fs.writeFileSync(path.join(assetsDir, 'icon.png'), buffer);
            
            console.log('Icon PNG generated successfully');
          "
      
      - name: Initialize database
        run: npm run db:init
      
      - name: Build Vite
        run: npm run build:vite
      
      - name: Build Electron
        run: npm run build:electron
      
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            release/*.exe
            release/*.dmg
            release/*.zip
            release/*.AppImage
            release/*.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
